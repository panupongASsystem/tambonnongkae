<?php
defined('BASEPATH') or exit('No direct script access allowed');

class Email_register extends MY_Controller
{

    public function __construct()
    {
        parent::__construct();
        // р╣Ар╕Кр╣Зр╕Д steb 1 р╕гр╕░р╕Ър╕Ър╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Бр╕Хр╕гр╕Зр╕бр╕▒р╣Йр╕в
        $this->check_access_permission(['1', '105']); // 1=р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф

        $this->load->model('user_log_model');
    }

    

    public function index()
    {
        // р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╕╡р╣Ар╕бр╕ер╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
        $data['emails'] = $this->user_log_model->list_email();
        $data['line_notification_status'] = $this->user_log_model->get_setting('line_notification_status');


        // р╣Вр╕лр╕ер╕Фр╕лр╕Щр╣Йр╕▓ view
        $this->load->view('templat/header');
        $this->load->view('asset/css');
        $this->load->view('templat/navbar_system_admin');
        $this->load->view('system_admin/email_register', $data);
        $this->load->view('asset/js');
        $this->load->view('templat/footer');
    }

    public function add()
    {
        // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
        if ($this->input->post('email_name')) {
            // р╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Йр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ add_email р╕Ир╕▓р╕Б model
            $this->user_log_model->add_email();
            redirect('Email_register');
        } else {
            // р╣Бр╕кр╕Фр╕Зр╣Бр╕Ър╕Ър╕Яр╕нр╕гр╣Мр╕б
            $this->load->view('templat/header');
            $this->load->view('asset/css');
            $this->load->view('templat/navbar_system_admin');
            $this->load->view('system_admin/email_register_form');
            $this->load->view('asset/js');
            $this->load->view('templat/footer');
        }
    }

    public function edit($email_id)
    {
        // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
        if ($this->input->post('email_name')) {
            // р╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Йр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ edit_email р╕Ир╕▓р╕Б model
            $this->user_log_model->edit_email($email_id);
            redirect('Email_register');
        } else {
            // р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╕╡р╣Ар╕бр╕ер╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕В
            $data['email'] = $this->user_log_model->read_email($email_id);

            // р╣Бр╕кр╕Фр╕Зр╣Бр╕Ър╕Ър╕Яр╕нр╕гр╣Мр╕б
            $this->load->view('templat/header');
            $this->load->view('asset/css');
            $this->load->view('templat/navbar_system_admin');
            $this->load->view('system_admin/email_register_edit', $data);
            $this->load->view('asset/js');
            $this->load->view('templat/footer');
        }
    }

    public function delete($email_id)
    {
        // р╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Йр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ del_email р╕Ир╕▓р╕Б model
        $this->user_log_model->del_email($email_id);
        redirect('Email_register');
    }

    public function update_status()
    {
        // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
        if ($this->input->post()) {
            // р╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Йр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ updateEmailStatus р╕Ир╕▓р╕Б model
            $this->user_log_model->updateEmailStatus();
        }
    }

    public function update_status_all()
    {
        // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
        if ($this->input->post('new_status')) {
            $new_status = $this->input->post('new_status');
            // р╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Йр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ updateEmailStatusAll р╕Ир╕▓р╕Б model
            $result = $this->user_log_model->updateEmailStatusAll($new_status);

            $response = array(
                'status' => $result ? 'success' : 'error',
                'message' => $result ? 'р╕нр╕▒р╕Юр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в' : 'р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕нр╕▒р╕Юр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░'
            );

            echo json_encode($response);
        }
    }

    public function test_email()
    {
        // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╕нр╕╡р╣Ар╕бр╕ер╕Чр╕╡р╣Ир╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
        $this->db->where('email_status', '1');
        $active_emails = $this->db->count_all_results('tbl_email');

        if ($active_emails == 0) {
            $this->session->set_flashdata('error', 'р╣Др╕бр╣Ир╕бр╕╡р╕нр╕╡р╣Ар╕бр╕ер╕Чр╕╡р╣Ир╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕нр╕╡р╣Ар╕бр╕ер╕нр╕вр╣Ир╕▓р╕Зр╕Щр╣Йр╕нр╕в 1 р╕гр╕▓р╕вр╕Бр╕▓р╕г');
            redirect('Email_register');
            return;
        }

        // р╕кр╣Ир╕Зр╕нр╕╡р╣Ар╕бр╕ер╕Чр╕Фр╕кр╕нр╕Ъ
        $subject = 'р╕Чр╕Фр╕кр╕нр╕Ър╕гр╕░р╕Ър╕Ър╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Чр╕▓р╕Зр╕нр╕╡р╣Ар╕бр╕е';
        $message = "р╕Щр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕нр╕╡р╣Ар╕бр╕ер╕Чр╕Фр╕кр╕нр╕Ър╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ър╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Др╕зр╕▓р╕бр╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕в\n";
        $message .= "р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Бр╕ер╕░р╣Ар╕зр╕ер╕▓р╕Чр╕Фр╕кр╕нр╕Ъ: " . date('Y-m-d H:i:s') . "\n";
        $message .= "р╕Ьр╕╣р╣Йр╕Чр╕Фр╕кр╕нр╕Ъ: " . $this->session->userdata('m_fname') . ' ' . $this->session->userdata('m_lname');

        $result = $this->user_log_model->send_line_email($subject, $message);

        if ($result) {
            $this->session->set_flashdata('success', 'р╕кр╣Ир╕Зр╕нр╕╡р╣Ар╕бр╕ер╕Чр╕Фр╕кр╕нр╕Ър╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з');
        } else {
            $this->session->set_flashdata('error', 'р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕нр╕╡р╣Ар╕бр╕ер╕Чр╕Фр╕кр╕нр╕Ъ');
        }

        redirect('Email_register');
    }

    /**
     * р╕кр╕│р╕лр╕гр╕▒р╕Ър╕нр╕▒р╕Юр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ Line OA
     */
    public function update_notification_status()
    {
        if ($this->input->post()) {
            $new_status = $this->input->post('status');
            $result = $this->user_log_model->update_setting(
                'line_notification_status',
                $new_status,
                $this->session->userdata('m_fname')
            );

            $response = array(
                'status' => $result ? 'success' : 'error',
                'message' => $result ? 'р╕нр╕▒р╕Юр╣Ар╕Фр╕Хр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в' : 'р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕нр╕▒р╕Юр╣Ар╕Фр╕Хр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓'
            );

            echo json_encode($response);
        }
    }

    /**
 * р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ Line OA (р╕кр╣Ир╕Зр╣Др╕Ыр╕Чр╕▒р╣Йр╕Зр╕кр╕нр╕Зр╕Бр╕ер╕╕р╣Ир╕б)
 */
	public function test_line_notification()
    {
        // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Цр╕╣р╕Бр╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
        $notification_status = $this->user_log_model->get_setting('line_notification_status');

        if ($notification_status != '1') {
            $response = array(
                'status' => 'error',
                'message' => 'р╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ Line OA р╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕нр╕вр╕╣р╣И р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Бр╣Ир╕нр╕Щр╕Чр╕Фр╕кр╕нр╕Ъ'
            );

            echo json_encode($response);
            return;
        }

        // р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕Фр╕кр╕нр╕Ъ
        $message = "ЁЯФФ р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ Line OA\n";
        $message .= "р╕гр╕░р╕Ър╕Ър╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Др╕зр╕▓р╕бр╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕в\n";
        $message .= "-------------------------------\n";
        $message .= "ЁЯСд р╕Ьр╕╣р╣Йр╕Чр╕Фр╕кр╕нр╕Ъ: " . $this->session->userdata('m_fname') . ' ' . $this->session->userdata('m_lname') . "\n";
        $message .= "тП░ р╣Ар╕зр╕ер╕▓: " . date('Y-m-d H:i:s') . "\n";
        $message .= "ЁЯУ▒ р╕кр╣Ир╕Зр╣Др╕Ыр╕вр╕▒р╕З: р╕Бр╕ер╕╕р╣Ир╕бр╕Ьр╕╣р╣Йр╕Фр╕╣р╣Бр╕ер╕гр╕░р╕Ър╕Ъ + р╕Бр╕ер╕╕р╣Ир╕бр╕ер╕╣р╕Бр╕Др╣Йр╕▓\n";
        $message .= "тЬЕ р╕Щр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕Фр╕кр╕нр╕Ър╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ";

        // === р╕кр╣Ир╕Зр╣Др╕Ыр╕Бр╕ер╕╕р╣Ир╕бр╕Ьр╕╣р╣Йр╕Фр╕╣р╣Бр╕ер╕гр╕░р╕Ър╕Ъ (р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Ар╕бр╕╖р╣Ир╕н login р╕Ьр╕┤р╕Ф) ===
        $admin_result = $this->user_log_model->send_line_alert($message);

        // === р╕кр╣Ир╕Зр╣Др╕Ыр╕Бр╕ер╕╕р╣Ир╕бр╕ер╕╣р╕Бр╕Др╣Йр╕▓ ===
        $customer_result = $this->user_log_model->send_line_customer($message);

        // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╣Бр╕ер╕░р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ъ
        $success_groups = [];
        $failed_groups = [];

        if ($admin_result) {
            $success_groups[] = "р╕Бр╕ер╕╕р╣Ир╕бр╕Ьр╕╣р╣Йр╕Фр╕╣р╣Бр╕ер╕гр╕░р╕Ър╕Ъ";
        } else {
            $failed_groups[] = "р╕Бр╕ер╕╕р╣Ир╕бр╕Ьр╕╣р╣Йр╕Фр╕╣р╣Бр╕ер╕гр╕░р╕Ър╕Ъ";
        }

        if ($customer_result) {
            $success_groups[] = "р╕Бр╕ер╕╕р╣Ир╕бр╕ер╕╣р╕Бр╕Др╣Йр╕▓";
        } else {
            $failed_groups[] = "р╕Бр╕ер╕╕р╣Ир╕бр╕ер╕╣р╕Бр╕Др╣Йр╕▓";
        }

        // р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ъ
        if (count($success_groups) > 0) {
            $message_text = "р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕Фр╕кр╕нр╕Ър╕кр╕│р╣Ар╕гр╣Зр╕Ир╣Др╕Ыр╕вр╕▒р╕З: " . implode(", ", $success_groups);

            if (count($failed_groups) > 0) {
                $message_text .= " | р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з: " . implode(", ", $failed_groups);
            }

            $response = array(
                'status' => 'success',
                'message' => $message_text
            );
        } else {
            $response = array(
                'status' => 'error',
                'message' => 'р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕Фр╕кр╕нр╕Ър╣Др╕Ыр╕Чр╕▒р╣Йр╕Зр╕кр╕нр╕Зр╕Бр╕ер╕╕р╣Ир╕б'
            );
        }

        // р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б log р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Фр╕╡р╕Ър╕▒р╕Б
        log_message('debug', 'LINE Test Results:');
        log_message('debug', '- Admin group (send_line_alert): ' . ($admin_result ? 'SUCCESS' : 'FAILED'));
        log_message('debug', '- Customer group (send_line_customer): ' . ($customer_result ? 'SUCCESS' : 'FAILED'));

        echo json_encode($response);
    }
}
